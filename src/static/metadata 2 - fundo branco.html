<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Sentiment Analyzer - Chainlink Functions + OpenAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .step.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .step.completed {
            opacity: 1;
            color: var(--success-color);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary-color);
        }

        .analysis-card h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .attribute-badge {
            background: linear-gradient(45deg, var(--primary-color), #3b82f6);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            margin: 5px;
            display: inline-block;
            font-size: 0.9em;
        }

        .keyword-tag {
            background: var(--secondary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 3px;
            display: inline-block;
            font-size: 0.85em;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #3b82f6);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #059669);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .config-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .debug-section {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: var(--success-color);
        }

        .status-disconnected {
            background: var(--danger-color);
        }

        .nft-preview {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .metadata-json {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .step {
                margin: 0 5px;
            }
            
            .step-text {
                display: none;
            }
            
            .main-container {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container p-4">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-4 fw-bold text-primary">
                    <i class="fas fa-brain me-3"></i>NFT Sentiment Analyzer
                </h1>
                <p class="lead text-muted">Análise de Sentimentos com Chainlink Functions + OpenAI</p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <span class="step-text">Upload</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <span class="step-text">Análise</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <span class="step-text">Preview</span>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <span class="step-text">Mint NFT</span>
                </div>
            </div>

            <!-- Wallet Status -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="config-section">
                        <h6><i class="fas fa-wallet me-2"></i>Status da Carteira</h6>
                        <p id="walletStatus">
                            <span class="status-indicator status-disconnected"></span>
                            Carteira não conectada
                        </p>
                        <button class="btn btn-outline-primary btn-sm" onclick="connectWallet()">
                            Conectar Carteira
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="config-section">
                        <h6><i class="fas fa-cog me-2"></i>Configurações</h6>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <label class="form-label">Contrato OpenAI:</label>
                                <input type="text" class="form-control form-control-sm" id="openaiContractAddress" 
                                       placeholder="0x..." value="">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Contrato NFT:</label>
                                <input type="text" class="form-control form-control-sm" id="nftContractAddress" 
                                       placeholder="0x..." value="">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Subscription ID:</label>
                                <input type="number" class="form-control form-control-sm" id="subscriptionId" 
                                       value="15580">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Upload -->
            <div id="uploadSection" class="mb-4">
                <h3><i class="fas fa-upload me-2"></i>1. Upload da Imagem</h3>
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Clique aqui ou arraste uma imagem</h5>
                    <p class="text-muted">Formatos suportados: JPG, PNG, GIF (máx. 10MB)</p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>
                
                <div id="imagePreview" class="text-center mt-3" style="display: none;">
                    <img id="previewImg" class="preview-image" alt="Preview">
                    <div class="mt-3">
                        <p><strong>Hash IPFS:</strong> <span id="ipfsHash" class="text-primary"></span></p>
                        <button class="btn btn-primary" onclick="startAnalysis()">
                            <i class="fas fa-brain me-2"></i>Iniciar Análise de Sentimentos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Analysis Loading -->
            <div id="analysisSection" class="mb-4" style="display: none;">
                <h3><i class="fas fa-brain me-2"></i>2. Análise de Sentimentos</h3>
                
                <div id="analysisLoading" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Executando análise via Chainlink Functions + OpenAI...</p>
                    <small class="text-muted">Isso pode levar alguns minutos</small>
                </div>

                <div id="analysisError" class="alert alert-danger" style="display: none;">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro na Análise</h6>
                    <p id="errorMessage"></p>
                    <button class="btn btn-outline-danger btn-sm" onclick="retryAnalysis()">
                        <i class="fas fa-redo me-2"></i>Tentar Novamente
                    </button>
                </div>
            </div>

            <!-- Step 3: Analysis Results Preview -->
            <div id="previewSection" class="mb-4" style="display: none;">
                <h3><i class="fas fa-eye me-2"></i>3. Pré-visualização da Análise</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="analysis-card">
                            <h5><i class="fas fa-heart me-2"></i>Análise de Sentimentos</h5>
                            <p id="sentimentAnalysis"></p>
                        </div>
                        
                        <div class="analysis-card">
                            <h5><i class="fas fa-palette me-2"></i>Psicologia das Cores</h5>
                            <p id="colorPsychology"></p>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="analysis-card">
                            <h5><i class="fas fa-symbols me-2"></i>Relação Simbólica</h5>
                            <p id="symbolRelation"></p>
                        </div>
                        
                        <div class="analysis-card">
                            <h5><i class="fas fa-image me-2"></i>Linguagem Visual</h5>
                            <p id="visualLanguage"></p>
                        </div>
                    </div>
                </div>

                <div class="analysis-card">
                    <h5><i class="fas fa-tags me-2"></i>Palavras-chave</h5>
                    <div id="keywords"></div>
                </div>

                <div class="analysis-card">
                    <h5><i class="fas fa-list me-2"></i>Atributos NFT</h5>
                    <div id="attributes"></div>
                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-success btn-lg" onclick="proceedToMint()">
                        <i class="fas fa-check me-2"></i>Aprovar e Prosseguir para Mint
                    </button>
                    <button class="btn btn-outline-secondary btn-lg ms-3" onclick="retryAnalysis()">
                        <i class="fas fa-redo me-2"></i>Refazer Análise
                    </button>
                </div>
            </div>

            <!-- Step 4: NFT Mint -->
            <div id="mintSection" class="mb-4" style="display: none;">
                <h3><i class="fas fa-coins me-2"></i>4. Mint do NFT</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="nft-preview">
                            <h5>Preview do NFT</h5>
                            <img id="nftPreviewImage" class="preview-image mb-3" alt="NFT Preview">
                            
                            <div class="mb-3">
                                <label class="form-label">Nome do NFT:</label>
                                <input type="text" class="form-control" id="nftName" placeholder="Meu NFT Incrível">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Descrição:</label>
                                <textarea class="form-control" id="nftDescription" rows="3" 
                                          placeholder="Descrição do NFT baseada na análise..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="nft-preview">
                            <h5>Metadados JSON</h5>
                            <div class="metadata-json" id="metadataPreview"></div>
                            
                            <div class="mt-3">
                                <button class="btn btn-success btn-lg w-100" onclick="mintNFT()">
                                    <i class="fas fa-hammer me-2"></i>Mint NFT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="mintLoading" class="loading-spinner">
                    <div class="spinner-border text-success" role="status"></div>
                    <p class="mt-3">Fazendo mint do NFT...</p>
                </div>

                <div id="mintSuccess" class="alert alert-success text-center" style="display: none;">
                    <h5><i class="fas fa-check-circle me-2"></i>NFT Criado com Sucesso!</h5>
                    <p>Seu NFT foi criado e está disponível na blockchain.</p>
                    <p><strong>Transaction Hash:</strong> <span id="mintTxHash"></span></p>
                    <button class="btn btn-primary" onclick="resetForm()">
                        <i class="fas fa-plus me-2"></i>Criar Outro NFT
                    </button>
                </div>
            </div>

            <!-- Debug Section -->
            <div class="debug-section">
                <h6><i class="fas fa-bug me-2"></i>Debug & Logs</h6>
                <div id="debugLogs"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <script>
        // Global variables
        let currentProvider = null;
        let currentSigner = null;
        let currentAccount = null;
        let currentImageHash = null;
        let currentAnalysisData = null;
        
        // Contract ABIs
        const OPENAI_CONTRACT_ABI = [
            "function sendSimpleRequest(uint64 subscriptionId, string[] calldata args) external returns (bytes32)",
            "function getLastResponse() external view returns (bytes memory, bytes memory)",
            "function getAnalysisData() external view returns (string, string, string, string, string, string)",
            "event RequestSent(bytes32 requestId, string imageHash)",
            "event ResponseReceived(bytes32 requestId, string analysis)",
            "event AnalysisComplete(bytes32 indexed requestId, string sentimentAnalysis, string colorPsychology, string symbolRelation, string visualLanguage, string keywords, string attributes)"
        ];

        const NFT_CONTRACT_ABI = [
            "function mintWithSentiment(address to, string memory tokenURI, string memory ipfsImageHash, string memory sentimentAnalysis, string memory colorPsychology, string memory symbolRelation, string memory visualLanguage, string[] memory keywords) public returns (uint256)",
            "function totalSupply() external view returns (uint256)",
            "function getSentimentData(uint256 tokenId) external view returns (tuple(string sentimentAnalysis, string colorPsychology, string symbolRelation, string visualLanguage, string[] keywords, string ipfsImageHash, uint256 timestamp))",
            "event NFTMinted(uint256 indexed tokenId, address indexed to, string tokenURI, string ipfsImageHash)"
        ];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('Página carregada. Inicializando...');
            setupEventListeners();
            checkWalletConnection();
        });

        // Setup event listeners
        function setupEventListeners() {
            // File input
            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
            
            // Drag and drop
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        }

        // Wallet connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    logDebug('Conectando carteira...');
                    
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentProvider = new ethers.providers.Web3Provider(window.ethereum);
                    currentSigner = currentProvider.getSigner();
                    currentAccount = await currentSigner.getAddress();
                    
                    updateWalletStatus(true);
                    logDebug(`Carteira conectada: ${currentAccount}`);
                } else {
                    throw new Error('MetaMask não encontrado');
                }
            } catch (error) {
                logDebug(`Erro ao conectar carteira: ${error.message}`);
                updateWalletStatus(false);
            }
        }

        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        currentProvider = new ethers.providers.Web3Provider(window.ethereum);
                        currentSigner = currentProvider.getSigner();
                        currentAccount = accounts[0];
                        updateWalletStatus(true);
                        logDebug(`Carteira já conectada: ${currentAccount}`);
                    }
                } catch (error) {
                    logDebug(`Erro ao verificar conexão: ${error.message}`);
                }
            }
        }

        function updateWalletStatus(connected) {
            const statusElement = document.getElementById('walletStatus');
            if (connected) {
                statusElement.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    Conectado: ${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}
                `;
            } else {
                statusElement.innerHTML = `
                    <span class="status-indicator status-disconnected"></span>
                    Carteira não conectada
                `;
            }
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        async function processFile(file) {
            try {
                logDebug(`Processando arquivo: ${file.name}`);
                
                // Validate file
                if (!file.type.startsWith('image/')) {
                    throw new Error('Arquivo deve ser uma imagem');
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('Arquivo muito grande (máx. 10MB)');
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Upload to IPFS
                await uploadToIPFS(file);
                
            } catch (error) {
                logDebug(`Erro ao processar arquivo: ${error.message}`);
                alert(`Erro: ${error.message}`);
            }
        }

        async function uploadToIPFS(file) {
            try {
                logDebug('Fazendo upload para IPFS...');
                
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('https://nft-fuji-minter.onrender.com/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const hash = data.IpfsHash || data.ipfs_hash || data.hash;
                
                if (!hash) {
                    throw new Error('Hash IPFS não encontrado na resposta');
                }

                currentImageHash = hash;
                document.getElementById('ipfsHash').textContent = hash;
                
                logDebug(`Upload IPFS concluído: ${hash}`);
                updateStep(1, 'completed');
                
            } catch (error) {
                logDebug(`Erro no upload IPFS: ${error.message}`);
                throw error;
            }
        }

        // Analysis functions
        async function startAnalysis() {
            try {
                if (!currentAccount) {
                    await connectWallet();
                    if (!currentAccount) {
                        throw new Error('Carteira não conectada');
                    }
                }

                if (!currentImageHash) {
                    throw new Error('Nenhuma imagem foi carregada');
                }

                const contractAddress = document.getElementById('openaiContractAddress').value;
                if (!contractAddress) {
                    throw new Error('Endereço do contrato OpenAI não configurado');
                }

                logDebug('Iniciando análise de sentimentos...');
                
                // Show analysis section
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('analysisLoading').style.display = 'block';
                updateStep(2, 'active');

                // Call Chainlink Functions contract
                const contract = new ethers.Contract(contractAddress, OPENAI_CONTRACT_ABI, currentSigner);
                const subscriptionId = document.getElementById('subscriptionId').value;
                
                logDebug(`Chamando contrato: ${contractAddress}`);
                logDebug(`Subscription ID: ${subscriptionId}`);
                logDebug(`Image Hash: ${currentImageHash}`);

// PAREI 20250620 - AQUI ERRO =  Erro na análise: cannot estimate gas; transaction may fail or may require manual gas limit 

                const tx = await contract.sendSimpleRequest(subscriptionId, [currentImageHash]);
                logDebug(`Transação enviada: ${tx.hash}`);

                // Wait for transaction
                const receipt = await tx.wait();
                logDebug(`Transação confirmada no bloco: ${receipt.blockNumber}`);

                // Listen for events and poll for results
                await waitForAnalysisResults(contract);

            } catch (error) {
                logDebug(`Erro na análise: ${error.message}`);
                showAnalysisError(error.message);
            }
        }

        async function waitForAnalysisResults(contract) {
            const maxAttempts = 30; // 5 minutes max
            let attempts = 0;

            const checkResults = async () => {
                try {
                    attempts++;
                    logDebug(`Verificando resultados (tentativa ${attempts}/${maxAttempts})...`);

                    const [response, error] = await contract.getLastResponse();
                    
                    if (response && response !== '0x') {
                        // Got response
                        const analysisResult = ethers.utils.toUtf8String(response);
                        logDebug(`Resultado recebido: ${analysisResult}`);
                        
                        await processAnalysisResult(analysisResult);
                        return;
                    }

                    if (error && error !== '0x') {
                        // Got error
                        const errorMessage = ethers.utils.toUtf8String(error);
                        throw new Error(`Chainlink Functions error: ${errorMessage}`);
                    }

                    if (attempts >= maxAttempts) {
                        throw new Error('Timeout: Análise não completada em 5 minutos');
                    }

                    // Wait and try again
                    setTimeout(checkResults, 10000); // Check every 10 seconds

                } catch (error) {
                    logDebug(`Erro ao verificar resultados: ${error.message}`);
                    showAnalysisError(error.message);
                }
            };

            // Start checking
            setTimeout(checkResults, 10000); // Wait 10 seconds before first check
        }

        async function processAnalysisResult(analysisResult) {
            try {
                logDebug('Processando resultado da análise...');
                
                // Parse JSON result
                const analysisData = JSON.parse(analysisResult);
                currentAnalysisData = analysisData;

                // Hide loading
                document.getElementById('analysisLoading').style.display = 'none';
                
                // Show preview section
                document.getElementById('previewSection').style.display = 'block';
                updateStep(2, 'completed');
                updateStep(3, 'active');

                // Populate analysis data
                document.getElementById('sentimentAnalysis').textContent = analysisData.sentiment_analysis || 'Não disponível';
                document.getElementById('colorPsychology').textContent = analysisData.color_psychology || 'Não disponível';
                document.getElementById('symbolRelation').textContent = analysisData.symbol_relation || 'Não disponível';
                document.getElementById('visualLanguage').textContent = analysisData.visual_language || 'Não disponível';

                // Keywords
                const keywordsContainer = document.getElementById('keywords');
                keywordsContainer.innerHTML = '';
                if (analysisData.keywords && Array.isArray(analysisData.keywords)) {
                    analysisData.keywords.forEach(keyword => {
                        const tag = document.createElement('span');
                        tag.className = 'keyword-tag';
                        tag.textContent = keyword;
                        keywordsContainer.appendChild(tag);
                    });
                }

                // Attributes
                const attributesContainer = document.getElementById('attributes');
                attributesContainer.innerHTML = '';
                if (analysisData.attributes && Array.isArray(analysisData.attributes)) {
                    analysisData.attributes.forEach(attr => {
                        const badge = document.createElement('span');
                        badge.className = 'attribute-badge';
                        badge.textContent = `${attr.trait_type}: ${attr.value}`;
                        attributesContainer.appendChild(badge);
                    });
                }

                logDebug('Análise processada com sucesso');

            } catch (error) {
                logDebug(`Erro ao processar resultado: ${error.message}`);
                showAnalysisError(`Erro ao processar resultado: ${error.message}`);
            }
        }

        function showAnalysisError(message) {
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('analysisError').style.display = 'block';
        }

        function retryAnalysis() {
            document.getElementById('analysisError').style.display = 'none';
            startAnalysis();
        }

        // Mint functions
        function proceedToMint() {
            if (!currentAnalysisData) {
                alert('Dados de análise não disponíveis');
                return;
            }

            // Show mint section
            document.getElementById('mintSection').style.display = 'block';
            updateStep(3, 'completed');
            updateStep(4, 'active');

            // Set preview image
            document.getElementById('nftPreviewImage').src = document.getElementById('previewImg').src;

            // Generate default name and description
            const defaultName = `Sentiment NFT #${Date.now()}`;
            const defaultDescription = `NFT com análise de sentimentos: ${currentAnalysisData.sentiment_analysis?.substring(0, 100)}...`;
            
            document.getElementById('nftName').value = defaultName;
            document.getElementById('nftDescription').value = defaultDescription;

            // Generate metadata preview
            updateMetadataPreview();

            // Scroll to mint section
            document.getElementById('mintSection').scrollIntoView({ behavior: 'smooth' });
        }

        function updateMetadataPreview() {
            const name = document.getElementById('nftName').value || 'Untitled NFT';
            const description = document.getElementById('nftDescription').value || 'NFT with sentiment analysis';

            const metadata = {
                name: name,
                description: description,
                image: `ipfs://${currentImageHash}`,
                attributes: currentAnalysisData.attributes || [],
                sentiment_analysis: currentAnalysisData.sentiment_analysis,
                color_psychology: currentAnalysisData.color_psychology,
                symbol_relation: currentAnalysisData.symbol_relation,
                visual_language: currentAnalysisData.visual_language,
                keywords: currentAnalysisData.keywords || []
            };

            document.getElementById('metadataPreview').textContent = JSON.stringify(metadata, null, 2);
        }

        // Update metadata preview when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('nftName')?.addEventListener('input', updateMetadataPreview);
            document.getElementById('nftDescription')?.addEventListener('input', updateMetadataPreview);
        });

        async function mintNFT() {
            try {
                logDebug('Iniciando mint do NFT...');
                
                if (!currentAccount) {
                    throw new Error('Carteira não conectada');
                }

                if (!currentAnalysisData) {
                    throw new Error('Dados de análise não disponíveis');
                }

                const nftContractAddress = document.getElementById('nftContractAddress').value;
                if (!nftContractAddress) {
                    throw new Error('Endereço do contrato NFT não configurado');
                }

                document.getElementById('mintLoading').style.display = 'block';

                // Preparar metadados
                const name = document.getElementById('nftName').value || 'Untitled NFT';
                const description = document.getElementById('nftDescription').value || 'NFT with sentiment analysis';

                const metadata = {
                    name: name,
                    description: description,
                    image: `ipfs://${currentImageHash}`,
                    attributes: currentAnalysisData.attributes || [],
                    sentiment_analysis: currentAnalysisData.sentiment_analysis,
                    color_psychology: currentAnalysisData.color_psychology,
                    symbol_relation: currentAnalysisData.symbol_relation,
                    visual_language: currentAnalysisData.visual_language,
                    keywords: currentAnalysisData.keywords || []
                };

                logDebug('Fazendo upload dos metadados para IPFS...');

                // Upload metadata to IPFS
                const metadataResponse = await fetch('https://nft-fuji-minter.onrender.com/api/upload-metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (!metadataResponse.ok) {
                    throw new Error(`Erro no upload de metadados: ${metadataResponse.statusText}`);
                }

                const metadataData = await metadataResponse.json();
                const metadataURI = `ipfs://${metadataData.IpfsHash || metadataData.ipfs_hash || metadataData.hash}`;
                
                logDebug(`Metadados enviados para IPFS: ${metadataURI}`);

                // Mint NFT
                const nftContract = new ethers.Contract(nftContractAddress, NFT_CONTRACT_ABI, currentSigner);
                
                logDebug('Chamando função mintWithSentiment...');

                const tx = await nftContract.mintWithSentiment(
                    currentAccount,
                    metadataURI,
                    currentImageHash,
                    currentAnalysisData.sentiment_analysis || '',
                    currentAnalysisData.color_psychology || '',
                    currentAnalysisData.symbol_relation || '',
                    currentAnalysisData.visual_language || '',
                    currentAnalysisData.keywords || []
                );

                logDebug(`Transação de mint enviada: ${tx.hash}`);

                // Wait for confirmation
                const receipt = await tx.wait();
                logDebug(`NFT mintado no bloco: ${receipt.blockNumber}`);

                // Extract token ID from events
                const mintEvent = receipt.events?.find(e => e.event === 'NFTMinted');
                const tokenId = mintEvent?.args?.tokenId?.toString();

                // Show success
                document.getElementById('mintLoading').style.display = 'none';
                document.getElementById('mintTxHash').innerHTML = `
                    <a href="https://testnet.snowtrace.io/tx/${tx.hash}" target="_blank">${tx.hash}</a>
                    ${tokenId ? `<br><strong>Token ID:</strong> ${tokenId}` : ''}
                `;
                document.getElementById('mintSuccess').style.display = 'block';
                
                updateStep(4, 'completed');
                logDebug(`NFT mintado com sucesso! Token ID: ${tokenId}`);

            } catch (error) {
                logDebug(`Erro no mint: ${error.message}`);
                document.getElementById('mintLoading').style.display = 'none';
                alert(`Erro no mint: ${error.message}`);
            }
        }

        function resetForm() {
            // Reset all sections
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('mintSection').style.display = 'none';
            
            // Reset steps
            updateStep(1, 'active');
            updateStep(2, '');
            updateStep(3, '');
            updateStep(4, '');
            
            // Reset variables
            currentImageHash = null;
            currentAnalysisData = null;
            
            // Clear inputs
            document.getElementById('imageInput').value = '';
            
            logDebug('Formulário resetado');
        }

        // Utility functions
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const debugLogs = document.getElementById('debugLogs');
            debugLogs.innerHTML += logEntry + '<br>';
            debugLogs.scrollTop = debugLogs.scrollHeight;
            
            console.log(logEntry);
        }
    </script>
</body>
</html>

